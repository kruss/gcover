require 'rake/gempackagetask'

GEM_NAME 	= "gcover"
GEM_VERSION = "0.1.0"

### ALL ###################################################

desc "Complete rebuild, test, install & makefile example"
task :all => [:clobber_package, :gem_install, :make_example_gcover] do
end

desc "Complete clean"
task :all_clean => [:clobber_package, :make_example_clean] do		
end

### GEM ###################################################

spec = Gem::Specification.new do |s|
	s.name = GEM_NAME
	s.version = GEM_VERSION
	s.author = "Kevin russ"
	s.email = "kruss@lear.com"
	s.platform = Gem::Platform::RUBY
	s.summary = "Generates gcov code-coverage for cppunit-tests"
	s.files = FileList["{bin,tests,lib,docs}/**/*"].exclude("rdoc").to_a
	s.require_path = "lib"
	s.has_rdoc = true
	s.extra_rdoc_files = ["README"]
	s.executables = [GEM_NAME]
end
Rake::GemPackageTask.new(spec) {|pkg|}
task :gem => [:gem_test] 

desc "Install the gem"
task :gem_install => [:gem] do
    run_cmd("gem install pkg/#{spec.name}-#{spec.version}.gem")
end

desc "Uninstall the gem"
task :gem_uninstall do
    run_cmd("gem uninstall #{spec.name}")
end

desc "Test the gem"
task :gem_test do
    Dir.chdir("tests") do
		run_cmd("ruby ts_gcover.rb")
    end
end

### MAKEFILE EXAMPLE ######################################

desc "Clean makefile example"
task :make_example_clean do

	files = FileList.new("example/**/*.gcno")
	files.include("example/**/*.gcda")
	files.include("example/**/*.gcov")
	FileUtils.rm(files)
	FileUtils.rm_rf("example/.gcover") 
	
    Dir.chdir("example/Logger/Debug") do
		run_cmd("make clean")
    end
    Dir.chdir("example/Logger/UnitTestLib") do
		run_cmd("make clean")
    end
    Dir.chdir("example/FooLib/Debug") do
		run_cmd("make clean")
    end
    Dir.chdir("example/FooLib/UnitTest") do
		run_cmd("make clean")
    end   
    Dir.chdir("example/Dummy/Debug") do
		run_cmd("make clean")
    end
end

desc "Build makefile example"
task :make_example_build => [:make_example_clean] do

    Dir.chdir("example/Logger/Debug") do
		run_cmd("make all")
    end
    Dir.chdir("example/Logger/UnitTestLib") do
		run_cmd("make all")
    end
    Dir.chdir("example/FooLib/Debug") do
		run_cmd("make all")
    end
    Dir.chdir("example/FooLib/UnitTest") do
		run_cmd("make all")
    end   
    Dir.chdir("example/Dummy/Debug") do
		run_cmd("make all")
    end
end

desc "Run makefile example"
task :make_example_run => [:make_example_build] do

    Dir.chdir("example/FooLib/UnitTest") do
		run_cmd("./FooLib.exe")
    end   
    Dir.chdir("example/Dummy/Debug") do
		run_cmd("./Dummy.exe")
    end  
end

desc "Gcover makefile example"
task :make_example_gcover => [:make_example_run] do
    run_cmd("gcover example")
end

### CXXPROJECT EXAMPLE ####################################

desc "Clean cxxproject example"
task :cxx_example_clean do

    Dir.chdir("example/Dummy") do
		run_cmd("rake clobber")
    end
    Dir.chdir("example/FooLib") do
		run_cmd("rake clobber")
    end
end

desc "Build cxxproject example"
task :cxx_example_build => [:cxx_example_clean] do

    Dir.chdir("example/FooLib") do
		run_cmd("rake FooLib")
    end
    Dir.chdir("example/Dummy") do
		run_cmd("rake Dummy")
    end
end

desc "Run cxxproject example"
task :cxx_example_run => [:cxx_example_build] do

    Dir.chdir("example/Dummy/build") do
		run_cmd("./Dummy.exe")
    end   
    Dir.chdir("example/FooLib/build") do
		run_cmd("./FooLib.exe")
    end   
end

desc "Gcover cxxproject example"
task :cxx_example_gcover => [:cxx_example_run] do
    run_cmd("gcover example -cxx")
end

### TOOLS #################################################

def run_cmd(cmd)
    if !system(cmd) then
    	puts "unable to run: "+cmd
    	exit(-1)
    end
end

###########################################################