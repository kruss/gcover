require 'rake/gempackagetask'

spec = Gem::Specification.new do |s|
	s.name = "gcover"
	s.version = "0.1.0"
	s.author = "Kevin russ"
	s.email = "kruss@lear.com"
	s.platform = Gem::Platform::RUBY
	s.summary = "Generates gcov code-coverage for cppunit-tests"
	s.files = FileList["{bin,tests,lib,docs}/**/*"].exclude("rdoc").to_a
	s.require_path = "lib"
	s.has_rdoc = true
	s.extra_rdoc_files = ["README"]
	s.executables = ["gcover"]
end
Rake::GemPackageTask.new(spec) {|pkg|}

desc "install gem"
task :gem_install do
    run_cmd("gem install pkg/gcover-*.gem")
end

desc "uninstall gem"
task :gem_uninstall do
    run_cmd("gem uninstall gcover")
end

desc "run gem tests"
task :gem_test do
    Dir.chdir("tests") do
		run_cmd("ruby ts_gcover.rb")
    end
end

desc "complete rebuild, test, install & example"
task :all => [:clobber_package, :gem, :gem_test, :example, :gem_install] do
    system("gcover example")
end

desc "complete clean"
task :all_clean => [:clobber_package, :example_clean] do

	files = FileList.new("example/**/*.gcno")
	files.include("example/**/*.gcda")
	files.include("example/**/*.gcov")
	FileUtils.rm(files)
	FileUtils.rm_rf("example/.gcover") 		
end

desc "clean example workspace"
task :example_clean do

    Dir.chdir("example/Logger/Debug") do
		run_cmd("make clean")
    end
    Dir.chdir("example/Logger/UnitTestLib") do
		run_cmd("make clean")
    end
    Dir.chdir("example/FooLib/Debug") do
		run_cmd("make clean")
    end
    Dir.chdir("example/FooLib/UnitTest") do
		run_cmd("make clean")
    end   
    Dir.chdir("example/Dummy/Debug") do
		run_cmd("make clean")
    end
end

desc "build example workspace"
task :example_build => [:example_clean] do

    Dir.chdir("example/Logger/Debug") do
		run_cmd("make all")
    end
    Dir.chdir("example/Logger/UnitTestLib") do
		run_cmd("make all")
    end
    Dir.chdir("example/FooLib/Debug") do
		run_cmd("make all")
    end
    Dir.chdir("example/FooLib/UnitTest") do
		run_cmd("make all")
    end   
    Dir.chdir("example/Dummy/Debug") do
		run_cmd("make all")
    end
end

desc "run example unit-test"
task :example => [:example_build] do

    Dir.chdir("example/FooLib/UnitTest") do
		run_cmd("./FooLib.exe")
    end   
end

def run_cmd(cmd)
    if !system(cmd) then
    	puts "unable to run: "+cmd
    	exit(-1)
    end
end
